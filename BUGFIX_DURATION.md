# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –û—à–∏–±–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –≤ —Ä–µ–∂–∏–º–µ —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏–Ω–≥–∞

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ —Ñ–∏–ª—å–º–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é 1 —á–∞—Å 34 –º–∏–Ω—É—Ç—ã (94 –º–∏–Ω—É—Ç—ã) –≤ —Ä–µ–∂–∏–º–µ —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ ~26 –º–∏–Ω—É—Ç –ø–æ—è–≤–ª—è–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–≤—Å–µ —Å–µ—Ä–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã" –∏ —Ñ–∏–ª—å–º –æ—Ç–º–µ—á–∞–ª—Å—è –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π. –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–∑–∏—Ü–∏—è –ø–æ —Ç–∞–π–º–∏–Ω–≥—É –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å.

### –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–ª–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ:
- **–†–µ–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: 94 –º–∏–Ω—É—Ç—ã (5640 —Å–µ–∫—É–Ω–¥)
- **–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: ~26 –º–∏–Ω—É—Ç (1560 —Å–µ–∫—É–Ω–¥)
- –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 26 –º–∏–Ω—É—Ç: –ø—Ä–æ–≥—Ä–µ—Å—Å = 26/26 = 100% ‚Üí —Ñ–∏–ª—å–º –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–π

–≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∞–Ω–∞–ª–∏–∑–∞ –≤ `ffprobe`, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∞–ª –Ω–µ–ø–æ–ª–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ –≤–∏–¥–µ–æ.

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –£–≤–µ–ª–∏—á–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞ ffprobe (server.js)

–í —Ç—Ä—ë—Ö –º–µ—Å—Ç–∞—Ö (HEAD endpoint, GET endpoint, check-codec endpoint):

**–î–æ:**
```javascript
'-analyzeduration', '5000000',  // 5 —Å–µ–∫—É–Ω–¥
'-probesize', '5000000',         // 5 MB
```

**–ü–æ—Å–ª–µ:**
```javascript
'-analyzeduration', '100000000', // 100 —Å–µ–∫—É–Ω–¥ - –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
'-probesize', '50000000',        // 50 MB - –±–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
```

### 2. –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (server.js)

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- –í—ã–≤–æ–¥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö, –º–∏–Ω—É—Ç–∞—Ö –∏ —Ñ–æ—Ä–º–∞—Ç–µ MM:SS
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ä–º–∞—Ç–µ –∏–∑ ffprobe
- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```
‚úÖ HEAD: Video duration determined: 5640s (94:00 = 94.00 min)
   File: movie.mkv, Full format info: { ... }
```

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (app.js)

#### a) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
–ï—Å–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å < 10 –º–∏–Ω—É—Ç, –Ω–æ —É–∂–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ > 20 –º–∏–Ω—É—Ç:
```javascript
if (videoDuration < 600 && realTime > 1200) {
    console.warn('‚ö†Ô∏è Suspicious duration detected! ...');
    return; // –ù–µ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–µ
}
```

#### b) –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
–ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –±–æ–ª—å—à–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ - –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∏–Ω–∞–µ–º —Å –Ω–∞—á–∞–ª–∞.

#### c) –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
–§—É–Ω–∫—Ü–∏—è `cleanupInvalidPlaybackData()` —É–¥–∞–ª—è–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### 4. –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (app.js)

- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ HEAD –∑–∞–ø—Ä–æ—Å
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
- –õ–æ–≥–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –µ—Å–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å–º–æ–≤ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

1. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–∏–ø–∞:
   ```
   üßπ Cleaning up suspicious duration for [hash]_[index]: ...
   ‚úÖ Invalid playback data cleaned up
   ```

### –ü—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –Ω–æ–≤—ã—Ö —Ñ–∏–ª—å–º–æ–≤:

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞** (F12) –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
2. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç—Ä–∞–Ω—Å–∫–æ–¥–∏–Ω–≥–∞ —É–≤–∏–¥–∏—Ç–µ:
   ```
   üîç Requesting video duration via HEAD for transcoded stream: ...
   üìè Got duration from server: 5640s (94:00 = 94.00 min)
   üíæ Duration saved: 5640s (94.00 min) for ...
   ```
3. –í –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥):
   ```
   ‚è±Ô∏è currentTime: 125s, timeOffset: 0s, realTime: 125s (2:05)
   ```

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞** –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞** –Ω–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
   ```
   ‚ö†Ô∏è Suspicious duration detected! Saved duration: 1560s (26.00 min), 
       but already watched: 1800s (30.00 min)
   ```
3. **–û—á–∏—Å—Ç–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é** —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞:
   ```javascript
   localStorage.removeItem('playback_positions');
   localStorage.removeItem('watched_episodes');
   ```
4. **–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É** –∏ –Ω–∞—á–Ω–∏—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–Ω–æ–≤–æ

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ffprobe

- **analyzeduration**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Ç–æ–∫–∞ (–≤ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥–∞—Ö)
  - 100000000 –º–∫—Å = 100 —Å–µ–∫—É–Ω–¥
  - –ü–æ–∑–≤–æ–ª—è–µ—Ç ffprobe –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **probesize**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–≤ –±–∞–π—Ç–∞—Ö)
  - 50000000 –±–∞–π—Ç = 50 –ú–ë
  - –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–æ–ª—å—à–∏—Ö –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –±–∏—Ç—Ä–µ–π—Ç–æ–º

### –õ–æ–≥–∏–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

- –§–∏–ª—å–º/—Å–µ—Ä–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–∞—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ **90%** –æ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ü–æ–∑–∏—Ü–∏—è –æ—á–∏—â–∞–µ—Ç—Å—è –∑–∞ **30 —Å–µ–∫—É–Ω–¥** –¥–æ –∫–æ–Ω—Ü–∞ –≤–∏–¥–µ–æ
- –ü–æ–∑–∏—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ **10 —Å–µ–∫—É–Ω–¥** –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**: –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è > –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**: –ï—Å–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∞—è
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

28 –æ–∫—Ç—è–±—Ä—è 2025

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** - –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ –≤ server.js –∏ public/app.js

